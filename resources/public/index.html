<!DOCTYPE html>
<html>
<head>
    <title>Telegram Web App</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 16px;
            color: var(--tg-theme-text-color, #000);
            background: var(--tg-theme-bg-color, #fff);
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .section {
            margin-bottom: 24px;
        }

        h1, h2 {
            margin-bottom: 16px;
        }

        input {
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 10px;
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #fff);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 8px;
        }

        button:hover {
            opacity: 0.9;
        }

        .party-card {
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .party-card h3 {
            margin-top: 0;
            margin-bottom: 8px;
        }

        .members-list {
            margin-top: 8px;
        }

        .member {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }

        .ready-status {
            color: #666;
        }

        .ready-status.ready {
            color: #2ecc71;
        }

        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--tg-theme-bg-color, #fff);
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 320px;
            z-index: 1001;
        }

        .popup h2 {
            margin-top: 0;
        }

        .popup-close {
            position: absolute;
            right: 10px;
            top: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            width: auto;
        }

        .copy-code {
            cursor: pointer;
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: background 0.2s;
        }
        .copy-code:hover {
            background: var(--tg-theme-hint-color, #999);
        }
        .copy-icon {
            opacity: 0.7;
        }
        .copy-code:hover .copy-icon {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="section">
            <h1 style="color: var(--primary)">üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ç–∏</h1>
            
            <div class="section">
                <button onclick="showCreatePartyPopup()">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø–∞—Ç–∏</button>
                <button onclick="showJoinPartyPopup()">üîó –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –ø–∞—Ç–∏</button>
            </div>

            <div class="section">
                <h2>üìã –ú–æ–∏ –ø–∞—Ç–∏</h2>
                <div id="parties-list"></div>
            </div>
        </div>
    </div>

    <!-- –ü–æ–ø–∞–ø —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞—Ç–∏ -->
    <div id="create-party-popup" class="popup-overlay">
        <div class="popup">
            <button class="popup-close" onclick="hidePopup('create-party-popup')">√ó</button>
            <h2>‚ûï –ù–æ–≤–∞—è –ø–∞—Ç–∏</h2>
            <input type="text" id="party-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞—Ç–∏" required>
            <input type="number" id="threshold" placeholder="–¢—Ä–µ–±—É–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤" min="1" required>
            <input type="number" id="max-members" placeholder="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤" min="2" max="20" value="10" required>
            <small style="display: block; margin: 4px 0 12px; color: #666;">–ú–∏–Ω: 2, –ú–∞–∫—Å: 20</small>
            <button onclick="createParty()">–°–æ–∑–¥–∞—Ç—å –ø–∞—Ç–∏</button>
        </div>
    </div>

    <!-- –ü–æ–ø–∞–ø –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –ø–∞—Ç–∏ -->
    <div id="join-party-popup" class="popup-overlay">
        <div class="popup">
            <button class="popup-close" onclick="hidePopup('join-party-popup')">√ó</button>
            <h2>üîó –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –ø–∞—Ç–∏</h2>
            <input type="text" id="invite-code" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è" required>
            <button onclick="joinParty()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
        </div>
    </div>

    <script>
        let ws;
        
        function getWebSocketUrl() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            return `${protocol}//${window.location.host}/ws`;
        }

        function connectWebSocket() {
            const userId = initDataUnsafe.user?.id;
            
            ws = new WebSocket(getWebSocketUrl() + '?userId=' + userId);
            
            ws.onopen = function() {
                ws.send(JSON.stringify({
                    type: 'get-initial-state',
                    userId: userId
                }));
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.type === 'parties-update') {
                    renderParties(data.parties);
                } else if (data.type === 'error') {
                    Telegram.WebApp.showAlert(data.error);
                }
            };
            
            ws.onerror = function(error) {
                Telegram.WebApp.showAlert('Connection error');
            };
            
            ws.onclose = function(event) {
                setTimeout(connectWebSocket, 1000);
            };
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
        }

        function renderParties(parties) {
            const container = document.getElementById('parties-list');
            if (!container) return;
            const userId = initDataUnsafe.user?.id;
            
            const userParties = parties.filter(party => 
                party.members?.some(member => member.id === userId)
            );
            
            container.innerHTML = userParties.map(party => {
                return `
                <div class="party-card">
                    <h3>
                        ${party.name}
                    </h3>
                    <p>–ö–æ–¥: 
                        <strong class="copy-code" 
                            onclick="copyToClipboard('${party['invite-code']}')" 
                            title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">
                            ${party['invite-code']}
                            <span class="copy-icon">‚úÇÔ∏è</span>
                        </strong>
                    </p>
                    
                    <p>–ü–æ—Ä–æ–≥ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏: ${party.threshold}</p>
                    <p class="members-count" style="color: ${party['members']?.length >= party['max-members'] ? '#e74c3c' : party['members']?.length >= party['max-members'] * 0.8 ? '#f39c12' : '#2ecc71'}">
                        –£—á–∞—Å—Ç–Ω–∏–∫–∏: ${party['members']?.length || 0}/${party['max-members']}
                    </p>
                    ${party['members']?.find(m => m.id === initDataUnsafe.user?.id)?.ready ? `
                        <button onclick="unsetReady('${party.id}')" style="background: #e67e22;">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å</button>
                    ` : `
                        <button onclick="setReady('${party.id}')">‚úÖ –ì–æ—Ç–æ–≤</button>
                    `}
                    
                    ${party['creator-id'] === initDataUnsafe.user?.id ? `
                        <button 
                            style="background: #e74c3c; margin-top: 8px;" 
                            onclick="deleteParty('${party.id}')">
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ø–∞—Ç–∏
                        </button>
                    ` : `
                        <button 
                            style="background: #666; margin-top: 8px;" 
                            onclick="leaveParty('${party.id}')">
                            üö™ –ü–æ–∫–∏–Ω—É—Ç—å –ø–∞—Ç–∏
                        </button>
                    `}
                    
                    <p>–°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>
                    <div class="members-list">
                        ${party['members']?.map(member => `
                            <div class="member">
                                <span class="member-name">${member['first-name'] || "–ê–Ω–æ–Ω–∏–º"}</span>
                                <span class="ready-status ${member.ready ? 'ready' : ''}">
                                    ${member.ready ? '‚úÖ' : '‚óØ'}
                                </span>
                            </div>
                        `).join('') || '–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤'}
                    </div>
                </div>`;
            }).join('');
        }

        function checkWebSocketConnection() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                Telegram.WebApp.showAlert('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
                connectWebSocket();
                return false;
            }
            return true;
        }

        async function createParty() {
            if (!checkWebSocketConnection()) return;

            const name = document.getElementById('party-name').value.trim();
            const threshold = document.getElementById('threshold').value.trim();
            if (!name || !threshold) {
                Telegram.WebApp.showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            try {
                ws.send(JSON.stringify({
                    action: 'create-party',
                    userId: initDataUnsafe.user?.id || 'Unknown',
                    threshold: threshold,
                    name: name,
                    maxMembers: document.getElementById('max-members').value
                }));
                hidePopup('create-party-popup');
                Telegram.WebApp.showAlert('–ü–∞—Ç–∏ —Å–æ–∑–¥–∞–Ω–∞');
            } catch (error) {
                Telegram.WebApp.showAlert('Network error');
            }
        }

        async function joinParty() {
            if (!checkWebSocketConnection()) return;

            const inviteCode = document.getElementById('invite-code').value.trim();
            if (!inviteCode) {
                Telegram.WebApp.showAlert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è');
                return;
            }

            try {
                ws.send(JSON.stringify({
                    action: 'join-party',
                    userId: initDataUnsafe.user?.id || 'Unknown',
                    inviteCode: inviteCode
                }));
                hidePopup('join-party-popup');
                Telegram.WebApp.showAlert('–£—Å–ø–µ—à–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –ø–∞—Ç–∏!');
            } catch (error) {
                Telegram.WebApp.showAlert(error.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏');
            }
        }

        async function setReady(partyId) {
            if (!checkWebSocketConnection()) return;

            try {
                ws.send(JSON.stringify({
                    action: 'set-ready',
                    userId: initDataUnsafe.user?.id || 'Unknown',
                    partyId: partyId
                }));
                Telegram.WebApp.showAlert('–°—Ç–∞—Ç—É—Å –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª—ë–Ω!');
            } catch (error) {
                Telegram.WebApp.showAlert(error.message || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
            }
        }

        async function unsetReady(partyId) {
            if (!checkWebSocketConnection()) return;

            try {
                ws.send(JSON.stringify({
                    action: 'unset-ready',
                    userId: initDataUnsafe.user?.id || 'Unknown',
                    partyId: partyId
                }));
                Telegram.WebApp.showAlert('–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –æ—Ç–º–µ–Ω–µ–Ω–∞!');
            } catch (error) {
                Telegram.WebApp.showAlert(error.message || '–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏');
            }
        }

        async function leaveParty(partyId) {
            if (!checkWebSocketConnection()) return;

            try {
                ws.send(JSON.stringify({
                    action: 'leave-party',
                    userId: initDataUnsafe.user?.id || 'Unknown',
                    partyId: partyId
                }));
                Telegram.WebApp.showAlert('–í—ã —É—Å–ø–µ—à–Ω–æ –ø–æ–∫–∏–Ω—É–ª–∏ –ø–∞—Ç–∏!');
            } catch (error) {
                Telegram.WebApp.showAlert(error.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –ø–∞—Ç–∏');
            }
        }

        async function deleteParty(partyId) {
            if (!checkWebSocketConnection()) return;

            try {
                ws.send(JSON.stringify({
                    action: 'delete-party',
                    userId: initDataUnsafe.user?.id || 'Unknown',
                    partyId: partyId
                }));
                Telegram.WebApp.showAlert('–í—ã —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–∏–ª–∏ –ø–∞—Ç–∏!');
            } catch (error) {
                Telegram.WebApp.showAlert(error.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–∞—Ç–∏');
            }
        }

        function showCreatePartyPopup() {
            document.getElementById('create-party-popup').style.display = 'block';
        }

        function showJoinPartyPopup() {
            document.getElementById('join-party-popup').style.display = 'block';
        }

        function hidePopup(popupId) {
            document.getElementById(popupId).style.display = 'none';
        }

        Telegram.WebApp.ready();
        Telegram.WebApp.expand();

        const initData = Telegram.WebApp.initData;
        const initDataUnsafe = Telegram.WebApp.initDataUnsafe;

        connectWebSocket();

        Telegram.WebApp.onEvent('themeChanged', () => {
            document.body.style.backgroundColor = Telegram.WebApp.colorScheme;
        });

        Telegram.WebApp.onEvent('viewportChanged', () => {
            // Handle viewport changes if needed
        });
    </script>
</body>
</html>
